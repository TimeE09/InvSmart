<!DOCTYPE html>
<html lang="en">
  
<head>
  <meta charset="UTF-8">
  <title>Receive Items - SCAN System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

</script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f8f8f8;
      height: 100vh;
      overflow: hidden;
    }
    .header {
      background: #ec2c2c;
      height: 60px;
      display: flex;
      align-items: center;
      padding: 0 20px;
      font-size: 24px;
      color: white;
      font-weight: bold;
      font-style: italic;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .menu-toggle {
      font-size: 24px;
      margin-right: 20px;
      cursor: pointer;
    }
    .sidebar {
      position: fixed;
      top: 60px;
      left: 0;
      width: 220px;
      height: calc(100vh - 60px);
      background: white;
      box-shadow: 2px 0 6px rgba(0,0,0,0.1);
      transition: width 0.3s;
      overflow-y: auto;
    }
    .sidebar.collapsed { width: 70px; }
    .sidebar a {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      font-weight: bold;
      color: #333;
      text-decoration: none;
    }
    .sidebar a:hover { background: #f0f0f0; }
    .sidebar a i {
      margin-right: 10px;
      width: 24px;
      text-align: center;
    }
    .sidebar.collapsed a span { display: none; }
    .logout-btn {
      margin: 20px auto;
      display: block;
      background: #e05656;
      color: white;
      padding: 12px;
      width: 90%;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .main {
      margin-left: 220px;
      margin-top: 60px;
      padding: 20px;
      transition: margin-left 0.3s;
      height: calc(100vh - 60px);
      overflow-y: auto;
    }
    .sidebar.collapsed + .main { margin-left: 70px; }
    .logo {
      font-size: 28px;
      text-align: center;
      color: #7ec97e;
      font-weight: bold;
    }
    .sub-logo {
      font-style: italic;
      text-align: center;
      color: #7ec97e;
      margin-bottom: 20px;
    }
    .btn-top {
  display: block;
  margin: 10px auto 20px; /* เพิ่มห่าง header ให้ 80px */
  padding: 10px 20px;
  background: #e67e22;
  color: white;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  font-size: 18px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    form {
      max-width: 600px;
      margin: auto;
    }
    .form-input, select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .save-btn {
      width: 100%;
      background: #ec2c2c;
      color: white;
      padding: 14px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      margin-top: 20px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .save-btn:hover {
      background: #c0392b;
    }
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    .clear-btn, .export-btn {
      background: #f39c12;
      color: white;
      padding: 10px 20px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .export-btn {
      background: #3498db;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .table-wrapper {
      margin-top: 20px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    /* ตารางปรับเส้นขอบ */
    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      overflow: hidden;
      border-radius: 12px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    thead {
      background: #7ec97e;
      color: white;
    }
    thead th {
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
    }
    tbody tr {
      transition: background 0.3s;
    }
    tbody tr:hover {
      background: #e8f5e9;
    }
    tbody td {
      padding: 10px 12px;
      font-size: 15px;
      border: 1px solid #ddd;
      text-align: center;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none; justify-content: center; align-items: center;
      z-index: 20;
    }
    .modal-content {
      background: linear-gradient(135deg, #ffffff, #e8f5e9);
      padding: 30px 20px;
      border-radius: 16px;
      width: 90%;
      max-width: 480px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.25);
      display: flex; flex-direction: column; gap: 10px;
      animation: fadeInModal 0.3s ease-out;
    }
    .modal-content .modal-input, .modal-content select {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f9f9f9;
      transition: all 0.3s;
      margin-bottom: 10px;
    }
    .modal-content .modal-input:focus, .modal-content select:focus {
      border-color: #2ecc71;
      background: #ffffff;
      outline: none;
    }
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .modal-buttons button {
      flex: 1;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }
    .save-modal {
      background: #2ecc71;
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .save-modal:hover {
      background: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .cancel-modal {
      background: #e74c3c;
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .cancel-modal:hover {
      background: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    @keyframes fadeInModal {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOutModal {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }

    .pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 20px;
  gap: 8px;
  flex-wrap: wrap;
}

.pagination button {
  padding: 8px 16px;
  font-size: 14px;
  font-weight: bold;
  background: #f0f0f0;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
}

.pagination button:hover {
  background: #7ec97e;
  color: white;
  transform: translateY(-2px);
}

.pagination button:disabled {
  background: #7ec97e;
  color: white;
  font-weight: bold;
  cursor: default;
}

    .fade-out .modal-content {
      animation: fadeOutModal 0.3s forwards;
    }

    /* Toast Notification */
    #toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #2ecc71;
      color: white;
      padding: 14px 20px;
      border-radius: 8px;
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
      font-weight: bold;
      z-index: 9999;
      display: none;
      opacity: 1;
    }
    @media screen and (max-width: 768px) {
  .sidebar {
    width: 250px;
    height: 100vh;
    position: fixed;
    top: 60px;
    left: 0;
    z-index: 100; /* บังแค่พอดี */
    background: white;
    box-shadow: 2px 0 6px rgba(0,0,0,0.2);
    transition: transform 0.3s ease;
    transform: translateX(-100%); /* ปกติซ่อน */
  }
  .sidebar.open {
    transform: translateX(0); /* เปิด */
  }

  .main {
    margin-left: 0;
    padding: 20px;
    transition: filter 0.3s;
  }
  .main.blur {
    filter: blur(2px);
    pointer-events: none;
  }
}
.choices {
  width: 100%;
  margin-top: 10px; /* เทียบกับ input อื่น */
}

.choices__inner {
  width: 100%;
  min-height: 45px; /* ให้สูงเท่า input ปกติ */
  padding: 10px 12px; /* ปรับขอบให้คล้าย input */
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-sizing: border-box;
}

  </style>
</head>
<body>

<!-- Clear All Modal -->
<div class="modal" id="clearModal">
  <div class="modal-content">
    <h3>Confirm Clear All</h3>
    <p style="text-align: center; font-size: 16px;">Are you sure you want to clear all items?</p>
    <div class="modal-buttons">
      <button class="save-modal" onclick="confirmClearAll()">Yes, Clear</button>
      <button class="cancel-modal" onclick="closeClearModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Header -->
<div class="header">
  <div class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div> SCAN
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <a href="ReceiveItems.html"><i class="fas fa-box"></i><span>Receive Items</span></a>
  <a href="dispatch.html"><i class="fas fa-truck"></i><span>Dispatch Items</span></a>
  <a href="reports.html"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
  <a href="barcode.html"><i class="fas fa-barcode"></i><span>Scan Barcode</span></a>
  <a href="#"><i class="fas fa-cogs"></i><span>Inventory</span></a>
  <a href="#"><i class="fas fa-user"></i><span>Users</span></a>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- Main Content -->
<div class="main" id="main" >
  <button class="btn-top">📦 Receive Items</button>
<div style="text-align:center; margin-bottom: 20px;">
  <button onclick="setScanMode('manual')" style="background:#3498db; color:white; font-weight:bold; padding:10px 20px; margin:5px; border:none; border-radius:8px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.2);">✍️ Manual</button>
  <button onclick="setScanMode('scan')" style="background:#f39c12; color:white; font-weight:bold; padding:10px 20px; margin:5px; border:none; border-radius:8px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.2);">📷 Scan Barcode</button>
</div>


<form id="receiveForm" onsubmit="saveData(); return false;" style="max-width:500px; margin:auto; text-align:center;">
  
  <input id="invoiceNumber" class="form-input" type="text" placeholder="Invoice Number (Ex. INV001)" required>

  <input id="itemName" class="form-input" type="text" placeholder="Item Name" required>

  <input id="packageQty" class="form-input" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Package Quantity" required>
<input id="quantity" class="form-input" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Quantity" required>

  <select id="storageLocation" class="form-input" required>
    <option value="">Select Storage Location</option>
    <optgroup label="Zone A"></optgroup>
<option>A1A1</option>
<option>A1A2</option>
<option>A1A3</option>
<option>A1A4</option>
<option>A1A5</option>
<option>A1A6</option>
<option>A1A7</option>
<option>A2A1</option>
<option>A2A2</option>
<option>A2A3</option>
<option>A2A4</option>
<option>A2A5</option>
<option>A2A6</option>
<option>A2A7</option>
<optgroup label="Zone B"></optgroup>
<option>B1A1</option>
<option>B1A2</option>
<option>B1A3</option>
<option>B1A4</option>
<option>B1A5</option>
<option>B1A6</option>
<option>B1A7</option>
<option>B2A1</option>
<option>B2A2</option>
<option>B2A3</option>
<option>B2A4</option>
<option>B2A5</option>
<option>B2A6</option>
<option>B2A7</option>
<optgroup label="Zone C"></optgroup>
<option>C1A1</option>
<option>C1A2</option>
<option>C1A3</option>
<option>C1A4</option>
<option>C1A5</option>
<option>C1A6</option>
<option>C1A7</option>
<option>C2A1</option>
<option>C2A2</option>
<option>C2A3</option>
<option>C2A4</option>
<option>C2A5</option>
<option>C2A6</option>
<option>C2A7</option>
<optgroup label="Zone D"></optgroup>
<option>D1A1</option>
<option>D1A2</option>
<option>D1A3</option>
<option>D1A4</option>
<option>D1A5</option>
<option>D1A6</option>
<option>D1A7</option>
<option>D2A1</option>
<option>D2A2</option>
<option>D2A3</option>
<option>D2A4</option>
<option>D2A5</option>
<option>D2A6</option>
<option>D2A7</option>
<optgroup label="Zone E"></optgroup>
<option>E1A1</option>
<option>E1A2</option>
<option>E1A3</option>
<option>E1A4</option>
<option>E1A5</option>
<option>E1A6</option>
<option>E1A7</option>
<option>E2A1</option>
<option>E2A2</option>
<option>E2A3</option>
<option>E2A4</option>
<option>E2A5</option>
<option>E2A6</option>
<option>E2A7</option>
<optgroup label="Zone F"></optgroup>
<option>F1A1</option>
<option>F1A2</option>
<option>F1A3</option>
<option>F1A4</option>
<option>F1A5</option>
<option>F1A6</option>
<option>F1A7</option>
<option>F2A1</option>
<option>F2A2</option>
<option>F2A3</option>
<option>F2A4</option>
<option>F2A5</option>
<option>F2A6</option>
<option>F2A7</option>
<optgroup label="Zone G"></optgroup>
<option>G1A1</option>
<option>G1A2</option>
<option>G1A3</option>
<option>G1A4</option>
<option>G1A5</option>
<option>G1A6</option>
<option>G1A7</option>
<option>G2A1</option>
<option>G2A2</option>
<option>G2A3</option>
<option>G2A4</option>
<option>G2A5</option>
<option>G2A6</option>
<option>G2A7</option>
<optgroup label="Zone H"></optgroup>
<option>H1A1</option>
<option>H1A2</option>
<option>H1A3</option>
<option>H1A4</option>
<option>H1A5</option>
<option>H1A6</option>
<option>H1A7</option>
<option>H2A1</option>
<option>H2A2</option>
<option>H2A3</option>
<option>H2A4</option>
<option>H2A5</option>
<option>H2A6</option>
<option>H2A7</option>
<optgroup label="Zone I"></optgroup>
<option>I1A1</option>
<option>I1A2</option>
<option>I1A3</option>
<option>I1A4</option>
<option>I1A5</option>
<option>I1A6</option>
<option>I1A7</option>
<option>I2A1</option>
<option>I2A2</option>
<option>I2A3</option>
<option>I2A4</option>
<option>I2A5</option>
<option>I2A6</option>
<option>I2A7</option>
<optgroup label="Zone J"></optgroup>
<option>J1A1</option>
<option>J1A2</option>
<option>J1A3</option>
<option>J1A4</option>
<option>J1A5</option>
<option>J1A6</option>
<option>J1A7</option>
<option>J2A1</option>
<option>J2A2</option>
<option>J2A3</option>
<option>J2A4</option>
<option>J2A5</option>
<option>J2A6</option>
<option>J2A7</option>
<optgroup label="Zone K"></optgroup>
<option>K1A1</option>
<option>K1A2</option>
<option>K1A3</option>
<option>K1A4</option>
<option>K1A5</option>
<option>K1A6</option>
<option>K1A7</option>
<option>K2A1</option>
<option>K2A2</option>
<option>K2A3</option>
<option>K2A4</option>
<option>K2A5</option>
<option>K2A6</option>
<option>K2A7</option>

  </select>

  <input id="receiveDate" class="form-input" type="date" required>

  <input id="handledBy" class="form-input" type="text" placeholder="Handled By" required>

  <input id="remarks" class="form-input" type="text" placeholder="Remarks (Optional)">

  <button type="submit" class="save-btn">Save</button>

</form>

  <div class="action-buttons">
    <button class="clear-btn" onclick="clearAll()">🗑️ Clear All</button>
    <button class="export-btn" onclick="exportToExcel()">📄 Export Excel</button>
  </div>

  <div class="table-wrapper">
    <div id="itemsTable" style="padding-bottom: 50px;"></div>
  </div>
</div>
<!-- Edit Modal -->
<div class="modal" id="editModal">
  <div class="modal-content" style="width: 100%;">
    <h3>Edit Item</h3>
    <input id="editInvoiceNumber" class="modal-input" type="text" placeholder="Invoice Number (Ex. INV001) " style="width:90%;">
    <input id="editItemName" class="modal-input" type="text" placeholder="Item Name" style="width:90%;">
    <input id="editPackageQty" class="modal-input" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Package Qty" style="width: 90%;">
<input id="editQuantity" class="modal-input" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Quantity" style="width: 90%;">
    <select id="editStorageLocation" class="modal-input" style="width: 97%;">
      <option value="">Select Storage</option>
      <option>A1A1</option>
<option>A1A2</option>
<option>A1A3</option>
<option>A1A4</option>
<option>A1A5</option>
<option>A1A6</option>
<option>A1A7</option>
<option>A2A1</option>
<option>A2A2</option>
<option>A2A3</option>
<option>A2A4</option>
<option>A2A5</option>
<option>A2A6</option>
<option>A2A7</option>

<option>B1A1</option>
<option>B1A2</option>
<option>B1A3</option>
<option>B1A4</option>
<option>B1A5</option>
<option>B1A6</option>
<option>B1A7</option>
<option>B2A1</option>
<option>B2A2</option>
<option>B2A3</option>
<option>B2A4</option>
<option>B2A5</option>
<option>B2A6</option>
<option>B2A7</option>

<option>C1A1</option>
<option>C1A2</option>
<option>C1A3</option>
<option>C1A4</option>
<option>C1A5</option>
<option>C1A6</option>
<option>C1A7</option>
<option>C2A1</option>
<option>C2A2</option>
<option>C2A3</option>
<option>C2A4</option>
<option>C2A5</option>
<option>C2A6</option>
<option>C2A7</option>

<option>D1A1</option>
<option>D1A2</option>
<option>D1A3</option>
<option>D1A4</option>
<option>D1A5</option>
<option>D1A6</option>
<option>D1A7</option>
<option>D2A1</option>
<option>D2A2</option>
<option>D2A3</option>
<option>D2A4</option>
<option>D2A5</option>
<option>D2A6</option>
<option>D2A7</option>

<option>E1A1</option>
<option>E1A2</option>
<option>E1A3</option>
<option>E1A4</option>
<option>E1A5</option>
<option>E1A6</option>
<option>E1A7</option>
<option>E2A1</option>
<option>E2A2</option>
<option>E2A3</option>
<option>E2A4</option>
<option>E2A5</option>
<option>E2A6</option>
<option>E2A7</option>

<option>F1A1</option>
<option>F1A2</option>
<option>F1A3</option>
<option>F1A4</option>
<option>F1A5</option>
<option>F1A6</option>
<option>F1A7</option>
<option>F2A1</option>
<option>F2A2</option>
<option>F2A3</option>
<option>F2A4</option>
<option>F2A5</option>
<option>F2A6</option>
<option>F2A7</option>

<option>G1A1</option>
<option>G1A2</option>
<option>G1A3</option>
<option>G1A4</option>
<option>G1A5</option>
<option>G1A6</option>
<option>G1A7</option>
<option>G2A1</option>
<option>G2A2</option>
<option>G2A3</option>
<option>G2A4</option>
<option>G2A5</option>
<option>G2A6</option>
<option>G2A7</option>

<option>H1A1</option>
<option>H1A2</option>
<option>H1A3</option>
<option>H1A4</option>
<option>H1A5</option>
<option>H1A6</option>
<option>H1A7</option>
<option>H2A1</option>
<option>H2A2</option>
<option>H2A3</option>
<option>H2A4</option>
<option>H2A5</option>
<option>H2A6</option>
<option>H2A7</option>

<option>I1A1</option>
<option>I1A2</option>
<option>I1A3</option>
<option>I1A4</option>
<option>I1A5</option>
<option>I1A6</option>
<option>I1A7</option>
<option>I2A1</option>
<option>I2A2</option>
<option>I2A3</option>
<option>I2A4</option>
<option>I2A5</option>
<option>I2A6</option>
<option>I2A7</option>

<option>J1A1</option>
<option>J1A2</option>
<option>J1A3</option>
<option>J1A4</option>
<option>J1A5</option>
<option>J1A6</option>
<option>J1A7</option>
<option>J2A1</option>
<option>J2A2</option>
<option>J2A3</option>
<option>J2A4</option>
<option>J2A5</option>
<option>J2A6</option>
<option>J2A7</option>

<option>K1A1</option>
<option>K1A2</option>
<option>K1A3</option>
<option>K1A4</option>
<option>K1A5</option>
<option>K1A6</option>
<option>K1A7</option>
<option>K2A1</option>
<option>K2A2</option>
<option>K2A3</option>
<option>K2A4</option>
<option>K2A5</option>
<option>K2A6</option>
<option>K2A7</option>

    </select>
    <input id="editReceiveDate" class="modal-input" type="date" style="width: 90%;">
    <input id="editHandledBy" class="modal-input" type="text" placeholder="Handled By" style="width: 90%;">
    <input id="editRemarks" class="modal-input" type="text" placeholder="Remarks (optional)" style="width: 90%;">
    <div class="modal-buttons">
      <button class="save-modal" onclick="saveEdit()">Save</button>
      <button class="cancel-modal" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
  <div class="modal-content">
    <h3>Confirm Delete</h3>
    <p style="text-align: center; font-size: 16px;">Are you sure you want to delete this item?</p>
    <div class="modal-buttons">
      <button class="save-modal" onclick="deleteItem()">Yes, Delete</button>
      <button class="cancel-modal" onclick="closeDeleteModal()">Cancel</button>
    </div>
  </div>
</div>
<div class="modal" id="dateErrorModal">
  <div class="modal-content">
    <h3>Invalid Date</h3>
    <p style="text-align: center; font-size: 16px;">Receive Date cannot be in the future.</p>
    <div class="modal-buttons">
      <button class="save-modal" onclick="closeDateErrorModal()">OK</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast">Saved Successfully!</div>
<!-- Script -->
<script>
  let items = JSON.parse(localStorage.getItem('receiveItems')) || [];
  let editIndex = -1;
  let deleteIndex = -1;
  let currentPage = 1;
  const itemsPerPage = 5;
  
  
  // Sidebar Toggle
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
  const main = document.getElementById('main');
  const isMobile = window.innerWidth <= 768;

  if (isMobile) {
    sidebar.classList.toggle('open');
    main.classList.toggle('blur');
  } else {
    sidebar.classList.toggle('collapsed');
    main.classList.toggle('collapsed');
  }
}
  
  // Logout
  function logout() {
    if (confirm('Logout now?')) window.location.href = "login.html";
  }
  
  // Save New Item (Receive Mode)
  function saveData() {
  const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
  const packageQtyInput = document.getElementById('packageQty').value;
  const packageQty = packageQtyInput ? parseInt(packageQtyInput) : 0;
  const quantity = parseInt(document.getElementById('quantity').value);
  const itemName = document.getElementById('itemName').value.trim();
  const storageLocation = document.getElementById('storageLocation').value.trim();
  const receiveDate = document.getElementById('receiveDate').value;
  const handledBy = document.getElementById('handledBy').value.trim();
  const remarks = document.getElementById('remarks').value.trim();

  if (!itemName || isNaN(quantity) || quantity <= 0 || !storageLocation || !receiveDate || !handledBy) {
    alert("❗ Please fill in all required fields properly.");
    return;
  }
  const today = new Date();
  const selectedDate = new Date(receiveDate);
  if (selectedDate > today) {
    document.getElementById('dateErrorModal').style.display = 'flex';
  return;
  }

  items.push({ invoiceNumber, packageQty, itemName, quantity, quantityRemain: quantity, storageLocation, receiveDate, handledBy, remarks });
  localStorage.setItem('receiveItems', JSON.stringify(items));

  document.getElementById('receiveForm').reset();
  document.getElementById('receiveDate').value = getTodayDate();
  document.getElementById('invoiceNumber').focus();

  renderTable();
  showToast();
}

// Save Data with Barcode (Scan Mode)
function saveDataWithBarcode(invoiceNumberOnly,barcodeLast6) {
  const invoiceNumber = invoiceNumberOnly;
  const packageQty = parseInt(document.getElementById('packageQty').value);
  const quantity = parseInt(document.getElementById('quantity').value);
  const itemName = document.getElementById('itemName').value.trim();
  const storageLocation = document.getElementById('storageLocation').value.trim();
  const receiveDate = document.getElementById('receiveDate').value;
  const handledBy = document.getElementById('handledBy').value.trim();
  const remarks = document.getElementById('remarks').value.trim();

  const newItem = { invoiceNumber, packageQty, itemName, quantity, quantityRemain: quantity, storageLocation, receiveDate, handledBy, remarks, barcodeLast6 };
  items.push(newItem);
  localStorage.setItem('receiveItems', JSON.stringify(items));

  // แทนที่ reset form ทั้งหมด เรา reset ทีละตัว (ยกเว้น storageLocation)
  document.getElementById('invoiceNumber').value = '';
  document.getElementById('packageQty').value = '';
  document.getElementById('itemName').value = '';
  document.getElementById('quantity').value = '';
  document.getElementById('receiveDate').value = getTodayDate();
  document.getElementById('handledBy').value = 'scanner'; 
  document.getElementById('remarks').value = '';

  document.getElementById('itemName').removeAttribute('data-barcode-last6');
  document.getElementById('packageQty').style.display = 'none';
  document.getElementById('invoiceNumber').style.display = 'block';
  document.getElementById('invoiceNumber').focus();

  renderTable();
  showToast();
}
  
  // Render Table
  function renderTable() {
  const table = document.getElementById('itemsTable');

  if (items.length === 0) {
    table.innerHTML = '<p>No items found</p>';
    return;
  }

  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const pageItems = items.slice(start, end);

  let html = '<table><thead><tr><th>Invoice Number</th><th>Name Item</th><th>Package Qty</th><th>Qty</th><th>Storage</th><th>Receive Date</th><th>Handled By</th><th>Remarks</th><th>Actions</th></tr></thead><tbody>';
  pageItems.forEach((item, i) => {
    html += `<tr>
      <td>${item.invoiceNumber || ''}</td><td>${item.itemName}</td><td>${item.packageQty || ''}</td>
      <td>${item.quantity}</td>
      <td>${item.storageLocation}</td>
      <td>${item.receiveDate}</td>
      <td>${item.handledBy}</td>
      <td>${item.remarks}</td>
      <td>
        <button onclick="openModal(${start + i})" style="background:orange;border:none;padding:6px 8px;border-radius:4px;cursor:pointer;color:white;">✏️</button> 
        <button onclick="confirmDelete(${start + i})" style="background:red;border:none;padding:6px 8px;border-radius:4px;cursor:pointer;color:white;">🗑️</button>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';

  html += generatePagination(); // เรียก Pagination

  table.innerHTML = html;
}

  
  // Pagination
  function generatePagination() {
  const totalPages = Math.ceil(items.length / itemsPerPage);
  if (totalPages <= 1) return '';

  let paginationHTML = '<div class="pagination">';
  if (currentPage > 1) {
    paginationHTML += `<button onclick="prevPage()">⬅️ Prev</button>`;
  }
  for (let i = 1; i <= totalPages; i++) {
    if (i === currentPage) {
      paginationHTML += `<button disabled>${i}</button>`;
    } else {

      paginationHTML += `<button onclick="goToPage(${i})">${i}</button>`;
    }
  }
  if (currentPage < totalPages) {
    paginationHTML += `<button onclick="nextPage()">Next ➡️</button>`;
  }
  paginationHTML += '</div>';
  return paginationHTML;
}
  
  function goToPage(page) {
    currentPage = page;
    renderTable();
  }
  
  function nextPage() {
    const totalPages = Math.ceil(items.length / itemsPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      renderTable();
    }
  }
  
  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderTable();
    }
  }
  
  // Open Modal
  function openModal(index) {
    editIndex = index;
    const item = items[index];
    document.getElementById('editInvoiceNumber').value = item.invoiceNumber;
    document.getElementById('editItemName').value = item.itemName;
    document.getElementById('editPackageQty').value = item.packageQty;
    document.getElementById('editQuantity').value = item.quantity;
    document.getElementById('editStorageLocation').value = item.storageLocation;
    document.getElementById('editReceiveDate').value = item.receiveDate;
    document.getElementById('editHandledBy').value = item.handledBy;
    document.getElementById('editRemarks').value = item.remarks;
    document.getElementById('editModal').style.display = 'flex';
  }
  
  // Save Edited Item
  function saveEdit() {
  const invoiceNumber = document.getElementById('editInvoiceNumber').value.trim();
  const itemName = document.getElementById('editItemName').value.trim();
  const PackageQty = parseInt(document.getElementById('editPackageQty').value);
  const quantity = parseInt(document.getElementById('editQuantity').value); // ✅ เพิ่มบรรทัดนี้
  const storageLocation = document.getElementById('editStorageLocation').value.trim();
  const receiveDate = document.getElementById('editReceiveDate').value;
  const handledBy = document.getElementById('editHandledBy').value.trim();
  const remarks = document.getElementById('editRemarks').value.trim();

  // ✅ ตรวจเฉพาะช่องที่จำเป็น ไม่รวม remarks
  if (!itemName || isNaN(quantity) || quantity <= 0 || !storageLocation || !receiveDate || !handledBy) {
    alert("❗ Please fill in all required fields properly.");
    return;
  }

  items[editIndex] = {
    invoiceNumber,
    itemName,
    packageQty: PackageQty,
    quantity,
    storageLocation,
    receiveDate,
    handledBy,
    remarks,
    barcodeLast6: items[editIndex].barcodeLast6 || null
  };

  localStorage.setItem('receiveItems', JSON.stringify(items));
  closeModal();
  renderTable();
  showToast("Item updated successfully!");
}
  
  // Close Modal with Fade
  function closeModal() {
    const modal = document.getElementById('editModal');
    const content = modal.querySelector('.modal-content');
    content.classList.add('fade-out');
    setTimeout(() => {
      modal.style.display = 'none';
      content.classList.remove('fade-out');
      clearEditForm();
    }, 300);
  }
  
  // Clear Edit Form
  function clearEditForm() {
    document.getElementById('editInvoiceNumber').value = '';
    document.getElementById('editItemName').value = '';
    document.getElementById('editPackageQty').value = '';
    document.getElementById('editQuantity').value = '';
    document.getElementById('editStorageLocation').selectedIndex = 0;
    document.getElementById('editReceiveDate').value = '';
    document.getElementById('editHandledBy').value = '';
    document.getElementById('editRemarks').value = '';
  }
  
  // Confirm Delete
  function confirmDelete(index) {
    deleteIndex = index;
    document.getElementById('deleteModal').style.display = 'flex';
  }
  
  // Delete Item
  function deleteItem() {
    if (deleteIndex !== -1) {
      items.splice(deleteIndex, 1);
      localStorage.setItem('receiveItems', JSON.stringify(items));
      deleteIndex = -1;
      closeDeleteModal();
      renderTable();
    }
  }
  
  // Close Delete Modal
  function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    const content = modal.querySelector('.modal-content');
    content.classList.add('fade-out');
    setTimeout(() => {
      modal.style.display = 'none';
      content.classList.remove('fade-out');
    }, 300);
  }
  
  // Clear All
  function clearAll() {
  document.getElementById('clearModal').style.display = 'flex';
}
function confirmClearAll() {
  items = [];
  localStorage.removeItem('receiveItems');
  renderTable();
  closeClearModal();
  showToast("All data cleared!");
}

function closeClearModal() {
  const modal = document.getElementById('clearModal');
  const content = modal.querySelector('.modal-content');
  content.classList.add('fade-out');
  setTimeout(() => {
    modal.style.display = 'none';
    content.classList.remove('fade-out');
  }, 300);
}

// ปิดด้วย ESC หรือคลิกนอกกรอบ
document.getElementById('clearModal').addEventListener('click', function(event) {
  if (event.target === this) closeClearModal();
});
  
  // Export to Excel
  function exportToExcel() {
    if (items.length === 0) return alert('No data to export');
    const worksheet = XLSX.utils.json_to_sheet(items);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "ReceiveItems");
    XLSX.writeFile(workbook, "Receive_Items.xlsx");
  }
  
  // Show Toast
  function showToast(message = "Saved Successfully!") {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.display = 'block';
    toast.style.opacity = '1';
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 500);
    }, 2000);
  }
  
  // ESC Key / Click Outside Modal
  window.addEventListener('keydown', function(event) {
    if (event.key === "Escape") {
      if (document.getElementById('editModal').style.display === 'flex') closeModal();
      if (document.getElementById('deleteModal').style.display === 'flex') closeDeleteModal();
    }
  });
  document.getElementById('editModal').addEventListener('click', function(event) {
    if (event.target === this) closeModal();
  });
  document.getElementById('deleteModal').addEventListener('click', function(event) {
    if (event.target === this) closeDeleteModal();
  });
  
  
// === เสริมโหมด Scan/Manual และตรวจสอบเลข 6 หลักซ้ำ ===
let scanMode = 'manual';

function setScanMode(mode) {
  scanMode = mode;
  if (scanMode === 'scan') {
    document.getElementById('storageLocation').style.display = 'block';
    document.getElementById('handledBy').style.display = 'none';
    document.getElementById('handledBy').value = 'scanner';
    document.getElementById('invoiceNumber').style.display = 'block';
    document.getElementById('invoiceNumber').placeholder = 'Ex.3 20 INV001 123456';
    document.getElementById('packageQty').style.display = 'none';
    document.getElementById('itemName').style.display = 'none';
    document.getElementById('receiveDate').style.display = 'none';
    document.getElementById('receiveDate').value = getTodayDate();
    document.getElementById('invoiceNumber').focus();
    document.getElementById('quantity').style.display = 'none';
    document.getElementById('remarks').placeholder = 'remaks';
    document.getElementById('remarks').style.display = 'none';
  } else {
    document.getElementById('invoiceNumber').style.display = 'block';
    document.getElementById('packageQty').style.display = 'block';
    document.getElementById('itemName').placeholder = 'Item Name';
    document.getElementById('remarks').style.display = 'block';
    document.getElementById('quantity').style.display = 'block';
    document.getElementById('receiveDate').style.display = 'block';
    document.getElementById('itemName').style.display = 'block';
    document.getElementById('handledBy').style.display = 'block';
    document.getElementById('storageLocation').style.display = 'block';
    document.getElementById('invoiceNumber').placeholder = 'Invoice Number (Ex. INV001)';
  }
}

document.getElementById('invoiceNumber').addEventListener('keypress', function(e) {
  if (e.key === 'Enter' && scanMode === 'scan') {
    e.preventDefault();
    const raw = this.value.trim();
    const parts = raw.split(' ');

    if (parts.length >= 4) {
      const packageQty = parseInt(parts[0]);
      const quantity = parseInt(parts[1]);
      const invoiceNumberOnly = parts[2];   // ✅ ใช้ชื่อนี้กันสับสน
      const barcodeLast6 = parts[3];

      const receiveItems = JSON.parse(localStorage.getItem('receiveItems')) || [];
      const isDuplicate = receiveItems.some(item => item.barcodeLast6 === barcodeLast6);
      if (isDuplicate) {
        showToast("⚠️ เลขบาร์โค้ด 6 หลักท้าย (" + barcodeLast6 + ") มีอยู่ในระบบแล้ว!", "#e67e22");
        document.getElementById('invoiceNumber').value = '';
        return;
      }

      const itemName = findItemNameFromHistory(barcodeLast6, invoiceNumberOnly, quantity, packageQty);

      if (!itemName || itemName === '⚠ ไม่พบชื่อสินค้า') {
        showToast("❗ ไม่พบข้อมูลสินค้านี้ ", "#e74c3c");
        document.getElementById('invoiceNumber').value = '';
        return;
      }

      document.getElementById('itemName').value = itemName;
      document.getElementById('packageQty').value = packageQty;
      document.getElementById('quantity').value = quantity;
      document.getElementById('handledBy').value = 'scanner'; 
      document.getElementById('itemName').dataset.barcodeLast6 = barcodeLast6;

      // ✅ ส่ง invoiceNumberOnly ไป save
      saveDataWithBarcode(invoiceNumberOnly, barcodeLast6);
      showToast("✅ บันทึกสำเร็จ!");

      document.getElementById('invoiceNumber').value = '';
      document.getElementById('invoiceNumber').focus();
    } else {
      showToast("❗ Barcode format ไม่ถูกต้อง", "#e74c3c");
    }
  }
});

// เพิ่มฟังก์ชัน saveData แบบใหม่ให้รองรับ barcodeLast6
function saveDataWithBarcode(invoiceNumberOnly,barcodeLast6) {
  const invoiceNumber = invoiceNumberOnly;
  const packageQty = parseInt(document.getElementById('packageQty').value);
  const quantity = parseInt(document.getElementById('quantity').value);
  const itemName = document.getElementById('itemName').value.trim();
  const storageLocation = document.getElementById('storageLocation').value.trim();
  const receiveDate = document.getElementById('receiveDate').value;
  const handledBy = document.getElementById('handledBy').value.trim();
  const remarks = document.getElementById('remarks').value.trim();

  
  // 🔁 ตรวจว่า Running Number ซ้ำหรือไม่
  const duplicate = items.some(item => item.barcodeLast6 === barcodeLast6);
  if (duplicate) {
    document.getElementById('invoiceNumber').style.display = 'block';
    document.getElementById('invoiceNumber').value = '';
    showToast("⚠️ เลขบาร์โค้ด 6 หลักท้าย (" + barcodeLast6 + ") มีอยู่ในระบบแล้ว!", "#e67e22");
    document.getElementById('invoiceNumber').value = '';
    document.getElementById('packageQty').value = '';
    document.getElementById('quantity').value = '';
    document.getElementById('itemName').value = '';
    document.getElementById('itemName').dataset.barcodeLast6 = '';
    document.getElementById('invoiceNumber').focus();
    document.getElementById('storageLocation').value = lastSelectedStorageLocation;
    return;
  }

  document.getElementById('invoiceNumber').style.display = 'block';

const newItem = { invoiceNumber, packageQty, itemName, quantity, storageLocation, receiveDate, handledBy, remarks, barcodeLast6 };
  items.push(newItem);
  localStorage.setItem('receiveItems', JSON.stringify(items));
  document.getElementById('receiveDate').value = getTodayDate();
  document.getElementById('itemName').value = '';
// Removed to preserve for validation
  document.getElementById('invoiceNumber').focus();
  document.getElementById('itemName').removeAttribute('data-barcode-last6');
  document.getElementById('packageQty').style.display = 'none';
  document.getElementById('invoiceNumber').style.display = 'block';

  renderTable();
}

function getTodayDate() {
  const today = new Date();
  return today.toISOString().split('T')[0];
}
function closeDateErrorModal() {
  const modal = document.getElementById('dateErrorModal');
  const content = modal.querySelector('.modal-content');
  content.classList.add('fade-out');
  setTimeout(() => {
    modal.style.display = 'none';
    content.classList.remove('fade-out');
  }, 300);
}
let lastSelectedStorageLocation = '';

  // Init
  window.onload = renderTable;
  document.getElementById('receiveDate').max = getTodayDate();
  // === Listen to updates from other tabs/windows ===
const receiveChannel = new BroadcastChannel('receiveItems_channel');
receiveChannel.onmessage = (event) => {
  if (event.data === 'updated') {
    items = JSON.parse(localStorage.getItem('receiveItems')) || [];
    renderTable();
    showToast("📦 Data updated!");
  }
};
  
// === ใช้สำหรับค้นหา Item Name จาก barcodeHistories ===
function findItemNameFromHistory(barcodeLast6, invoiceNumber, qty, packageQty) {
  const histories = JSON.parse(localStorage.getItem('barcodeHistories')) || [];
  for (const h of histories) {
    const start = h.runningStart || 1;
    const rows = h.fileData || [];
    for (let i = 0; i < rows.length; i++) {
      const runningNumber = String(start + i).padStart(6, '0');
      if (
        runningNumber === barcodeLast6 &&
        (rows[i]['Invoice Number'] || '') === invoiceNumber &&
        String(rows[i]['Qty'] || '') === String(qty) &&
        String(rows[i]['Package Qty'] || '') === String(packageQty)
      ) {
        return rows[i]['Name Item'] || '';
      }
    }
  }
  return '';
}
['packageQty', 'quantity', 'editPackageQty', 'editQuantity'].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener('keypress', (e) => {
      if (!/[0-9]/.test(e.key)) {
        e.preventDefault(); // ห้ามพิมพ์ตัวอักษร
      }
    });
    input.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, ''); // ล้างตัวอักษรที่เผลอวาง Paste มา
    });
  }
});
document.addEventListener('DOMContentLoaded', function() {
  const element = document.getElementById('storageLocation');
  const choices = new Choices(element, {
    searchEnabled: true,
    itemSelectText: '', // ไม่ต้องมีข้อความเพิ่มเติมเวลาเลือก
    shouldSort: false   // เรียงตามที่เขียนไว้ ไม่เรียง A-Z อัตโนมัติ
  });
});
</script>
</body>
</html>
  